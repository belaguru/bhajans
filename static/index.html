<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Shree Kshetra Belaguru - Bhajana Maalika">
    <meta name="theme-color" content="#FF6B35">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Belaguru">
    
    <title>Shree Kshetra Belaguru - Bhajana Maalika</title>
    
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/logo-hanuman.png">
    <link rel="apple-touch-icon" href="/logo-hanuman.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/style.css?v=40">
</head>
<body class="bg-orange-50">
    <div id="app"></div>
    
    <script src="/app.js?v=40"></script>
    <script>
        // PWA Install State
        let deferredPrompt = null;
        let installPromptShown = false;

        // Register Service Worker for PWA support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(reg => {
                    console.log('‚úÖ Service Worker registered:', reg);
                })
                .catch(err => console.log('‚ùå Service Worker registration failed:', err));
        } else {
            console.warn('‚ö†Ô∏è Service Worker not supported');
        }

        // Fallback: Enable button after 5 seconds if beforeinstallprompt doesn't fire
        setTimeout(() => {
            const btn = document.getElementById('install-btn-header');
            if (btn && btn.disabled) {
                console.log('‚ö†Ô∏è beforeinstallprompt not fired, enabling button as fallback');
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        }, 5000);

        // PWA Install Prompt Handler
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üéâ beforeinstallprompt EVENT FIRED - PWA is ready!');
            console.log('üì± Install button is now enabled');
            e.preventDefault();
            deferredPrompt = e;
            installPromptShown = false;
            
            // Enable install button
            const btn = document.getElementById('install-btn-header');
            if (btn) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                console.log('‚úÖ Install button enabled and ready to click');
            }
        });

        // Global function to trigger install
        window.triggerInstall = async function() {
            if (!deferredPrompt) {
                console.warn('beforeinstallprompt event never fired');
                alert('Use browser menu to install:\n\nChrome/Edge: ‚ãÆ ‚Üí "Install app"\nSafari: Share ‚Üí "Add to Home Screen"\nFirefox: ‚ãØ ‚Üí "Install"');
                return;
            }
            try {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('User response:', outcome);
                if (outcome === 'accepted') {
                    console.log('‚úÖ App installation accepted');
                }
                deferredPrompt = null;
            } catch (err) {
                console.error('Install error:', err);
            }
        };

        // App Installed Event
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ App was installed successfully');
            deferredPrompt = null;
            installPromptShown = false;
        });

        // Global function to manually trigger install
        window.triggerInstall = async function() {
            if (!deferredPrompt) {
                console.warn('‚ùå Install prompt not ready yet');
                alert('Install not available yet. Please refresh the page and wait a few seconds.');
                return;
            }
            try {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;
            } catch (err) {
                console.error('Install error:', err);
            }
        };

        // Check if already installed
        if (window.navigator.standalone) {
            console.log('‚úÖ Already running as standalone app');
        }
    </script>
</body>
</html>
